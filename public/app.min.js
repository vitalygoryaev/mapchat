angular.module("mapchat",["angular-inview"]),angular.module("mapchat").filter("distance",function(){return function(e){return e<1?"Your current position":"Distance: "+e+"m"}}).filter("time",["$filter",function(e){return function(t){var s=new Date(t),i=(new Date).setHours(0,0,0,0),a=new Date(s).setHours(0,0,0,0);return i==a?e("date")(s,"HH:mm"):e("date")(s,"yyyy-MM-dd HH:mm")}}]),angular.module("mapchat").controller("index",["$scope","$anchorScroll","$sockets","$geolocation","$map",function(e,t,s,i,a){function n(t){c.locationStatus={code:"success"},c.position=i.position,e.$digest()}function o(t){c.locationStatus={message:"failed to get location",code:"fail"},console.log("failed to get location: "+JSON.stringify(t)),e.$digest()}function r(){c.lastMessageIsVisible&&t("afterMessagesAnchor")}var c=this;c.messages=[],c.radius=i.radius,c.userName=localStorage.getItem("userName"),c.showLocationError=!1,c.showMap=!1,c.showSettings=!1,c.locationStatus={code:"waiting",message:"waiting for your location..."},i.getCurrentPosition(n,o),i.startWatchPosition(n,o),s.onNewMessages(function(t){c.socketId="/#"+this.id,c.messages=t||[],e.$digest(),r()}),s.onHistoryDelivered(function(s){c.messages=c.messages.concat(s),e.$digest(),t(c.firstMessageId)}),s.onNewMessageReceived(function(t){c.messages.push(t),e.$digest(),r()}),this.sendMessage=function(e){return c.userName?(s.sendMessage(e,c.userName,c.position),void(c.messageText="")):(c.showSettings=!0,void $("#nickname").focus())},c.getMessageDistance=i.getMessageDistance,c.getHistory=function(e){c.lastMessageIsVisible||(console.log("loading history"),c.firstMessageId=e,s.getHistory(c.messages.length))},c.renderMap=function(e){a.renderMap(e,c.messages),c.showMap=!0},c.closeMap=function(){c.showMap=!1},c.closeSettings=function(){c.showSettings=!1,c.radius&&(localStorage.setItem("radius",c.radius),i.setRadius(c.radius)),c.userName&&localStorage.setItem("userName",c.userName)}}]),angular.module("mapchat").directive("header",function(){return{restrict:"E",replace:"true",templateUrl:"./javascripts/directives/templates/header.html"}}),angular.module("mapchat").directive("map",function(){return{restrict:"E",replace:"true",templateUrl:"./javascripts/directives/templates/map.html"}}),angular.module("mapchat").directive("message",function(){return{restrict:"E",replace:"true",templateUrl:"./javascripts/directives/templates/message.html"}}),angular.module("mapchat").directive("messageArea",function(){return{restrict:"E",replace:"true",templateUrl:"./javascripts/directives/templates/messageArea.html"}}),angular.module("mapchat").directive("messageList",function(){return{restrict:"E",replace:"true",templateUrl:"./javascripts/directives/templates/messageList.html"}}),angular.module("mapchat").directive("ngEnter",function(){return function(e,t,s){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(s.ngEnter)}),t.preventDefault())})}}),angular.module("mapchat").directive("sendMessageArea",function(){return{restrict:"E",replace:"true",templateUrl:"./javascripts/directives/templates/sendMessageArea.html"}}),angular.module("mapchat").directive("settings",function(){return{restrict:"E",replace:"true",templateUrl:"./javascripts/directives/templates/settings.html"}}),angular.module("mapchat").service("$geolocation",["$sockets",function(e){function t(t,s){i.position={longitude:s.coords.longitude,latitude:s.coords.latitude,accuracy:s.coords.accuracy},e.onNewPosition(i.position,i.radius),t()}function s(e,t,s,i){var a=Math.PI*e/180,n=Math.PI*s/180,o=t-i,r=Math.PI*o/180,c=Math.sin(a)*Math.sin(n)+Math.cos(a)*Math.cos(n)*Math.cos(r);return c=Math.acos(c),c=180*c/Math.PI,c=60*c*1.1515,c=1.609344*c*1e3}var i=this;i.radius=localStorage.getItem("radius")||300,i.startWatchPosition=function(e,s){navigator.geolocation.watchPosition(t.bind(null,e),s)},i.getCurrentPosition=function(e,s){navigator.geolocation.getCurrentPosition(t.bind(null,e),s)},i.getMessageDistance=function(e){return s(i.position.latitude,i.position.longitude,e.position.latitude,e.position.longitude)},i.setRadius=function(t){i.radius=t,e.onNewPosition(i.position,t)}}]),angular.module("mapchat").service("$map",function(){function e(e,s){if(s){var a=document.getElementById("map"),n={lat:e.position.latitude,lng:e.position.longitude};t||(t=new google.maps.Map(a,{zoom:18,center:n})),s.forEach(function(e){if(!i[e._id]){var s={lat:e.position.latitude,lng:e.position.longitude},a=new google.maps.InfoWindow({content:"<div><b>"+e.userName+"</b></div><div>"+e.messageText+"</div>",maxWidth:250,position:s});i[e._id]=a,a.open(t)}}),Object.keys(i).forEach(function(e){var t=!1;s.forEach(function(s){s._id===e&&(t=!0)}),t||(i[e].close(),delete i[e])}),t.setZoom(18),t.setCenter(n)}}var t,s=this,i={};s.renderMap=function(s,i){function a(){e(s,i)}t?a():setTimeout(a,500)}}),angular.module("mapchat").service("$sockets",function(){var e=this,t=io();e.onNewMessages=function(e){t.on("messagesDelivered",e)},e.onHistoryDelivered=function(e){t.on("historyDelivered",e)},e.onNewMessageReceived=function(e){t.on("newMessageReceived",e)},e.sendMessage=function(e,s,i){t.emit("newMessage",{messageText:e,position:i,userName:s})},e.onNewPosition=function(e,s){t.emit("newPosition",{position:e,radius:s})},e.getHistory=function(e){t.emit("getHistory",e)}});